<!DOCTYPE html>
<html lang="en" xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title th:text="${product.name}"></title>
    <link href="/product.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>

<body>
<div th:replace="~{ Normal/nav.html :: navbar }"></div>

<div class="box">
    <div>
        <img th:src="${product.image}" alt="goods image"/>
    </div>

    <div>
        <div>
            <h4 id="productName" th:text="${product.name}"></h4>
            <h4 id="price" th:text="${product.price}">円</h4>
            <span id="productNumber" th:text="${product.id}" style="display:none"></span>

            <h4> 注文 </h4>
            <div class="control" style="display: flex">
                <button class="btn btn-primary" type="button" data-id="minus">-</button>
                <span class="count">0</span>
                <button class="btn btn-primary" type="button" data-id="plus">+</button>
            </div>

            <div class="d-grid gap-2">
                <button class="btn btn-primary" type="button" data-id="buy">購入する</button>
                <button class="btn btn-primary" type="button" data-id="cart">カートに入れる</button>
                <h4>合計金額 : <span class="sum"></span></h4>
            </div>

            <span class="username" sec:authorize="isAuthenticated()" sec:authentication="principal.username"
                  style="display:none"></span>

        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
<script>
    let count = Number($('.count').html());
    const price = Number($('.price').html());

    $('[data-id="minus"]').on('click', function(){
        if (count<=1)
            return;

        count--;
        $('.count').html(count);
    })
    $('[data-id="plus"]').on('click', function(){
        count++;
        $('.count').html(count);
        $('.sum').html(count * price)
    })

    $('[data-id="buy"]').on('click', async function(){
        const res = await fetch ("/check-login",{credentials : 'include'});
        const json = await res.json();
        console.log(json);

        const confirm = window.confirm('本当に購入しますか？')
        if (!confirm) return;

        await fetch('/orderProduct',{
            method: 'POST',
            body: JSON.stringify({})
        })

    })
</script>
</body>
</html>